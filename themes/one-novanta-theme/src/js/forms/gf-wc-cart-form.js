/**
 * WooCommerce cart integration for Gravity Forms
 *
 * This script handles updating Gravity Form fields when
 * the WooCommerce cart is updated.
 */
/* global oneNovantaWcCart */
( function() {
	'use strict';

	// Bail if required data is missing
	if ( typeof oneNovantaWcCart === 'undefined' ) {
		return;
	}

	const formId = oneNovantaWcCart.formId;

	/**
	 * Update the form fields with current cart contents
	 */
	function updateCartFields() {
		// Create form data for POST request
		const formData = new FormData();
		formData.append( 'action', 'get_wc_cart_contents' );
		// phpcs:ignore WordPressVIPMinimum.JS.HTMLExecutingFunctions.append -- This is safe as it is generated by WordPress.
		formData.append( 'form_id', String( formId ) );
		// phpcs:ignore WordPressVIPMinimum.JS.HTMLExecutingFunctions.append -- This is safe as it is generated by WordPress.
		formData.append( '_wpnonce', String( oneNovantaWcCart.nonce ) );

		// Make fetch request to get formatted cart contents
		fetch( oneNovantaWcCart.ajaxUrl, {
			method: 'POST',
			body: formData,
			credentials: 'same-origin',
		} )
			.then( ( response ) => response.json() )
			.then( ( response ) => {
				if ( response.success && response.data ) {
					// Update each mapped field with its formatted value
					Object.keys( response.data ).forEach( function( fieldId ) {
						const inputSelector = '#input_' + formId + '_' + fieldId;
						const input = document.querySelector( inputSelector );
						if ( input ) {
							input.value = response.data[ fieldId ];
						}
					} );
				}
			} )
			.catch( ( error ) => {
				console.error( 'Error updating cart fields:', error ); // eslint-disable-line no-console
			} );
	}

	/**
	 * Initialize WooCommerce cart event listeners
	 */
	function init() {
		wp.hooks.addAction( 'ati_woocommerce_cart_updated', 'gf-wc-cart-form', updateCartFields );
		wp.hooks.addAction( 'ati_woocommerce_product_remove_all', 'gf-wc-cart-form', updateCartFields );
	}

	// Initialize on document ready
	document.addEventListener( 'DOMContentLoaded', function() {
		init();
	} );
}() );
